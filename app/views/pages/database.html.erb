<h1 class="display-4 text-center mt-5">Database Overview</h1>

<div class="container mt-4">
  <p class="lead text-white text-center">
    Here you can find an overview of all available apartments in our system.
  </p>

  <h1 class="text-center mb-4">All Apartments</h1>

  <div class="price-slider mb-3 text-center">
    <label for="price-range">Price Range: </label>
    <input type="range" id="price-range" min="0" max="4000000" step="1000" value="1000000">
    <span id="price-display">0 - 4,000,000</span>
  </div>

  <table class="table table-striped table-bordered table-dark text-white">
    <thead>
      <tr>
        <!-- Use plain text headers for client-side sorting -->
        <th data-column="id">ID</th>
        <th data-column="property">Property</th>
        <th data-column="floor">Floor</th>
        <th data-column="rooms">Rooms</th>
        <th data-column="size">Size</th>
        <th data-column="price">Base Price (CHF)</th>
      </tr>
    </thead>

    <tbody id="apartments-list">
      <% @apartments.each do |apartment| %>
        <tr class="apartment" data-price="<%= apartment.price.to_f %>" 
            style="cursor:pointer;"
            onclick="window.location='<%= wohnung_apartment_path(apartment.wohnung, apartment) %>'">
          <td><%= apartment.id %></td>
          <td><%= apartment.wohnung.name %></td>
          <td><%= apartment.floor %></td>
          <td><%= apartment.rooms %></td>
          <td><%= apartment.size %> mÂ²</td>
          <td><%= number_to_currency(apartment.price.to_i, unit: "CHF ", separator: ",", delimiter: ".", precision: 0) %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<script>
function setupSlider() {
  const priceSlider = document.getElementById('price-range');
  const priceDisplay = document.getElementById('price-display');
  const apartmentsList = document.getElementById('apartments-list');

  if (!priceSlider || !apartmentsList) return;

  const apartmentRows = apartmentsList.getElementsByClassName('apartment');

  // Set initial display
  priceDisplay.textContent = `0 - ${parseInt(priceSlider.value).toLocaleString()}`;

  // Remove any existing listeners to avoid duplicates
  const newSlider = priceSlider.cloneNode(true);
  priceSlider.parentNode.replaceChild(newSlider, priceSlider);

  newSlider.addEventListener('input', function () {
    const maxPrice = parseFloat(newSlider.value);
    priceDisplay.textContent = `0 - ${maxPrice.toLocaleString()}`;

    Array.from(apartmentRows).forEach(function (row) {
      const rowPrice = parseFloat(row.getAttribute('data-price'));
      row.style.display = (rowPrice <= maxPrice) ? '' : 'none';
    });
  });
}

// Helper to parse numbers, stripping currency formatting
function parseNumber(str) {
  return parseFloat(str.replace(/[^\d]/g, '')) || 0;
}

// Client-side table sorting
function setupSorting() {
  const table = document.querySelector('table');
  if (!table) return;
  const headers = table.querySelectorAll('th');
  const tbody = table.querySelector('tbody');

  // Columns with numeric values (ID, Floor, Rooms, Size, Price)
  const numericColumns = [0, 2, 3, 4, 5];

  headers.forEach((th, index) => {
    th.style.cursor = 'pointer';
    th.addEventListener('click', () => {
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const asc = !th.dataset.asc || th.dataset.asc === "false";

      rows.sort((a, b) => {
        let aText = a.children[index].innerText.trim();
        let bText = b.children[index].innerText.trim();

        if (numericColumns.includes(index)) {
          aText = parseNumber(aText);
          bText = parseNumber(bText);
        } else {
          aText = aText.toLowerCase();
          bText = bText.toLowerCase();
        }

        return asc ? (aText > bText ? 1 : -1) : (aText < bText ? 1 : -1);
      });

      rows.forEach(row => tbody.appendChild(row));
      th.dataset.asc = asc;
    });
  });
}

// Initialize slider and sorting on page load and Turbo navigation
document.addEventListener('DOMContentLoaded', () => {
  setupSlider();
  setupSorting();
});
document.addEventListener('turbo:load', () => {
  setupSlider();
  setupSorting();
});
</script>
